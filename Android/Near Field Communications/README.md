Near Field Communications overview
==================================
* close-range radio communication - 4 cm effective range
* effective for small bursts of data
* comes in 'active' and 'passive' forms, typically as in an active mobile device and a passive (sticker) tag  
* expected smart-phone penetration of 50% by 2013

### Android NFC development
* Android SDK 4.0 or higher with an NFC device (NFC is not supported by emulator yet) 

Installation
============
1. Install Eclipse
2. Install ADT plugin from update site https://dl-ssl.google.com/android/eclipse/
3. An Android wizard should appear automatically, run through it. Otherwise install latest Android SDK runtime 4.0.3, platform tools and USB drivers via Eclipse menu Window->Android SDK Manager.
4. Open Window->Android SDK Manager and install the default selected items.
5. Install [NDEF plugin](http://nfc-eclipse-plugin.googlecode.com) from update site http://nfc-eclipse-plugin.googlecode.com/git/nfc-eclipse-plugin-feature/update-site/ 
6. Install Android application [NFC Developer](https://play.google.com/store/apps/details?id=com.antares.nfc) from Android Play.

Task 1 - Create new tag
=========================
### a. Create new project
Create new Android project called 'HelloWorld NFC' and use package name com.helloworld.nfc.

### b. Create new NDEF file
Create a new file in the root of the project using New -> Other -> Near Field Communications -> NDEF File.

Hint: NDEF is a data format used in tags.
### c. Create an Android Application Record
1. Read online documentation about [Android Application Records](http://developer.android.com/guide/topics/nfc/nfc.html#aar).
2. Create an Android Application Record with package name 'no.java.schedule' using the NDEF editor.

Hint: Open NDEF file and right-click on the table.
### d. Write the Android Application Record to a tag.
Use the 'NFC Developer' application to scan the QR code generated by the editor. Write by holding a tag to the back of the device.

Hint: If get tag write IOException, try scanning again a bit slower.
### e. Try out the newly created tag
Close 'NFC Developer' application and navigate to the home screen. What happens when you scan the tag?

Hint: If you do not already have an application with identifier 'no.java.schedule' installed, Android will search for it at Google Play.

Task 2 - Hello NFC tag
===========================
### a. Launch hello world application from tag
1. Change the Android Application Record package from task 1 to 'com.helloworld.nfc', write it to tag.
2. Connect Android device via USB cable and launch hello world application via project -> 'run as Android application'.
3. Close the application, scan the tag, verify that hello world application starts.

### b. Change Hello World text by scanning a tag
Add NFC support for Hello World.

1. Add NFC [permissions](http://developer.android.com/guide/topics/nfc/nfc.html#manifest) to AndroidMainfest.xml:

		<!-- Near field communications permissions -->
        <uses-permission android:name="android.permission.NFC" />
	    <uses-feature android:name="android.hardware.nfc" android:required="true" />

2. Initialize NFC [foreground mode](http://developer.android.com/guide/topics/nfc/advanced-nfc.html#foreground-dispatch) in the Hello World activity:

    	protected NfcAdapter nfcAdapter;
        protected PendingIntent nfcPendingIntent;
        
		@Override
    	public void onCreate(Bundle savedInstanceState) {
        	super.onCreate(savedInstanceState);
        	setContentView(R.layout.main);
            
            // initialize NFC
        	nfcAdapter = NfcAdapter.getDefaultAdapter(this);
        	nfcPendingIntent = PendingIntent.getActivity(this, 0, new Intent(this, this.getClass()).addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP), 0);
    	}
	
3. Enable and disable foreground mode in onResume() and onPause():

		public void enableForegroundMode() {
		    Log.d(TAG, "enableForegroundMode");
		
			// foreground mode gives the current active application priority for reading scanned tags
        	IntentFilter tagDetected = new IntentFilter(NfcAdapter.ACTION_TAG_DISCOVERED); // filter for tags
        	IntentFilter[] writeTagFilters = new IntentFilter[] {tagDetected};
        	nfcAdapter.enableForegroundDispatch(this, nfcPendingIntent, writeTagFilters, null);
    	}
	
		public void disableForegroundMode() {
		    Log.d(TAG, "disableForegroundMode");
		
			nfcAdapter.disableForegroundDispatch(this);
		}

4. Change text from 'Hello world' to 'Hello NFC tag' when a tag is scanned:

    	@Override
    	public void onNewIntent(Intent intent) {
			// check for NFC related actions
        	if (NfcAdapter.ACTION_TAG_DISCOVERED.equals(intent.getAction())) {
        		TextView textView = (TextView) findViewById(R.id.title);
        		textView.setText("Hello NFC tag");
        	} else {
        		// ignore
        	}
    	}
	
Hint: Make sure you add attribute 'android:id="@+id/title"' to TextView in main.xml.

Verify functionality by scanning a tag.
### c. Read tag payload
Check for [NDEF](http://developer.android.com/guide/topics/nfc/nfc.html) messages using 

		Parcelable[] messages = intent.getParcelableArrayExtra(NfcAdapter.EXTRA_NDEF_MESSAGES);
		if (messages != null) {
			NdefMessage[] ndefMessages = new NdefMessage[messages.length];
		   	for (int i = 0; i < messages.length; i++) {
		   	    ndefMessages[i] = (NdefMessage) messages[i];
		   	}
		
    		Log.d(TAG, "Found " + ndefMessages.length + " NDEF messages");
		}


### d. Parse tag payload using [nfctools](https://github.com/grundid/nfctools/tree/master/nfctools-ndef/src/main/java/org/nfctools/ndef)
Create directory 'libs' and add [nfctools.jar](https://github.com/skjolber/Fagmote/raw/master/Android/Near%20Field%20Communications/HelloWorldNFC%20Base/libs/nfctools.jar) to your classpath.
Parse an NDEF message into records using

		NdefMessageDecoder ndefMessageDecoder = NdefContext.getNdefMessageDecoder();
		// parse to records - byte to POJO
		List<Record> records = ndefMessageDecoder.decodeToRecords(ndefMessages[i].toByteArray());

### e. Determine which NDEF record types are present on the tag.
Iterate of the parsed records and investigate their type and contents.

Did your tag contain the expected content?

Task 3 - device to device communication: Android Beam
=====================================================
Use [Android Beam](http://developer.android.com/guide/topics/nfc/nfc.html#p2p) to exchange information between two devices.

### a. Register push message callback interface 
Implement the CreateNdefMessageCallback interface and register callback using 

        // Register Android Beam callback
        nfcAdapter.setNdefPushMessageCallback(this, this);

### b. Write push message  
Compose an NdefMessage in the createNdefMessage(..) method:

		// create record
        TextRecord record = new TextRecord();
		// set text
		// ...
				
		// encode one or more records
        NdefMessageEncoder ndefMessageEncoder = NdefContext.getNdefMessageEncoder();
		return new NdefMessage(ndefMessageEncoder.encodeSingle(record));

### c. Read push message
Change text from 'Hello world' to 'Hello NFC device' when a is message pushed from another NFC device.

### d. Post push message notification
Implement the OnNdefPushCompleteCallback interface to show a notification when a message is pushed using Android Beam
	
        // Register callback to listen for message-sent success
        nfcAdapter.setOnNdefPushCompleteCallback(this, this);
    
        // Handle push success 
	    @Override
    	public void onNdefPushComplete(NfcEvent arg0) {
        	// A handler is needed to send messages to the activity when this
        	// callback occurs, because it happens from a binder thread
        	mHandler.obtainMessage(MESSAGE_SENT).sendToTarget();
	    }

	    private static final int MESSAGE_SENT = 1;   
	     
    	/** This handler receives a message from onNdefPushComplete */
    	private final Handler mHandler = new Handler() {
        	@Override
        	public void handleMessage(Message msg) {
            	switch (msg.what) {
            	case MESSAGE_SENT:
                	Toast.makeText(getApplicationContext(), "Message beamed!", Toast.LENGTH_LONG).show();
               	 break;
            	}
        	}
    	};
		

Bonus task - more NDEF record types
===================================
### a. Create well-known URI record.
### b. Create Mime Record.
What are the tag classes and their storage capactiy?
### c. Create External type Record.
### d. Create Android Application Record with an Mime Record.
Are you able to start the application and also read the Mime Record payload?



